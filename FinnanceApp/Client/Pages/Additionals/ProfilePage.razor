@page "/profile"
@layout MainLayout
@using System.IO;
@using Tewr.Blazor.FileReader
@inject IFileReaderService _fileService
@inject HttpClient _http
@inject FinnanceApp.Client.Services.IAuthService _aService
@attribute [Authorize]
<AuthorizeView>
    <Authorized Context="Auth">
        <div class="card shadow h-100 py-2">
            <div class="container">
                <h1>Profil</h1>
                <hr>
                <div class="row">
                    <!-- left column -->
                    <div class="col-md-3">
                        <div class="text-center">
                            <img class="avatar img-profile rounded-circle" alt="avatar"
                                src="@GetUserAvatar(@Auth.User.Claims.FirstOrDefault().Value)"
                                onerror="this.src='Avatars/avatar_0.jpg';">
                            <h6>Załącz nowy awatar</h6>
                            <input type="file" class="form-control" @ref="input"
                                @onchange="async () => await ImageChangedAsync()">
                            <button class="btn btn-block btn-primary" style="margin=5;"
                                @onclick="async () => await UploadFileAsync()">Zmień awatar</button>
                        </div>
                    </div>

                    <!-- edit form column -->
                    <div class="col-md-9 personal-info">
                        <EditForm class="form-horizontal" role="form" Model="@editProfile" OnValidSubmit="HandleEdit">
                            <Alert Message="@message" MessageType="@messageType"></Alert>
                            <DataAnnotationsValidator />
                            <ValidationSummary />
                            <div class="form-group">
                                <label class="col-lg-3 control-label">Nazwa użytkownika</label>
                                <div class="col-lg-8">
                                    <input class="form-control" type="text" @bind-value="editProfile.Username">
                                </div>
                            </div>

                            <div class="form-group">
                                <label class="col-lg-3 control-label">Email:</label>
                                <div class="col-lg-8">
                                    <input class="form-control" type="text" disabled="true"
                                        @bind-value="editProfile.Email">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-3 control-label">Hasło:</label>
                                <div class="col-md-8">
                                    <input class="form-control" type="password" @bind-value="editProfile.Password">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-3 control-label">Cel miesięczny:</label>
                                <div class="col-md-8">
                                    <input class="form-control" type="number" @bind-value="editProfile.TargetValue">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-md-3 control-label"></label>
                                <div class="col-md-8">
                                    <input type="submit" class="btn btn-primary" disabled="@isBusy"
                                        value="Zapisz zmiany">
                                </div>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
            <hr>
        </div>
    </Authorized>
</AuthorizeView>

@code{
    ElementReference input;
    Stream filestream = null;
    string fileName = String.Empty;
    private bool isBusy = false;
    FinnanceApp.Shared.Models.EditProfile editProfile = new FinnanceApp.Shared.Models.EditProfile();
    Models.AlertMessageType messageType = Models.AlertMessageType.Success;
    string message = string.Empty;
    protected override async Task OnInitializedAsync()
    {
        var user = await _aService.getUser();
        FinnanceApp.Shared.Models.EditProfile eprofile = new FinnanceApp.Shared.Models.EditProfile()
        {
            Username = user.Username,
            Email = user.Email,
            TargetValue = user.targetValue
        };
        editProfile = eprofile;
    }
    string GetUserAvatar(string id)
    {
        return "Avatars/avatar_" + id + ".jpg";
    }

    async Task ImageChangedAsync()
    {
        var file = (await _fileService.CreateReference(input).EnumerateFilesAsync()).FirstOrDefault();
        if (file == null)
            return;
        var fileinfo =  await file.ReadFileInfoAsync();
        fileName = fileinfo.Name;
        using(var ms = await file.CreateMemoryStreamAsync((int)fileinfo.Size))
        {
            filestream = new MemoryStream(ms.ToArray());
        }
    }
    async Task UploadFileAsync()
    {
        var content = new MultipartFormDataContent();
        content.Headers.ContentDisposition = new System.Net.Http.Headers.ContentDispositionHeaderValue("form-data");
        content.Add(new StreamContent(filestream, (int)filestream.Length), "image",fileName);

        var response = await _http.PostAsync("api/Avatar", content);

        if (response.IsSuccessStatusCode)
        {
            message ="New Avatar added corectly";
        }else
        {
            message = response.Content.ToString();
        }

    }

    async Task HandleEdit()
    {
        isBusy = true;
        var response = await _aService.EditProfile(editProfile);
        if (!response.isSuccess)
        {

            message = response.Message;
            messageType = Models.AlertMessageType.Error;
        }
        else
        {
            message = response.Message;
            messageType = Models.AlertMessageType.Success;
        }
        isBusy = false;

    }
}
<style>
    .img-profile {
        height: 35%;
        width: 35%;
    }
</style>